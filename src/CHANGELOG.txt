# CHANGELOG

## [Latest] - 2025-11-02

### Feature: Navbar MegaMenu with SSR Category Fetching
**Status**: ✅ COMPLETED (100%)

#### Changes Made:
1. **SSR Category Fetching**
   - Created: `src/modules/layout/Navbar/NavbarClient.jsx` (client component)
   - Updated: `src/modules/layout/Navbar/Navbar.jsx` (server component)
   - Integrated: `getCategoryTree()` from `categoriesApi.js` with ISR caching (revalidate: 300s)
   - Data flows from SSR parent to client child component

2. **Desktop MegaMenu**
   - Hover-activated dropdown with 3-column grid (responsive: 2 columns @ tablet, 1 @ mobile)
   - Category titles with subcategories listed beneath each parent
   - Smooth fade-in/fade-down animation (translateY + opacity)
   - Backdrop blur effect with dark overlay background
   - Persistent on hover with pointer-events management

3. **Mobile Accordion Menu**
   - "محصولات" button expands to show all categories
   - Each category displays with nested subcategories
   - Animated slideDown expansion with border accent
   - Proper state management for open/closed accordion
   - Closes menu on navigation link click

4. **SCSS Module Updates**
   - Added: `.megaMenuWrapper`, `.megaMenu`, `.megaMenuGrid`, `.megaMenuColumn`
   - Added: `.mobileCategoryToggle`, `.mobileSubMenu`, `.mobileCategoryGroup`, `.mobileSubList`
   - Used design tokens: `var(--color-overlay)`, `var(--color-text-primary)`, `var(--font-md)`, etc.
   - Applied mixins: `@include hover-transition`, `@include respond()`
   - Animations: slideDown keyframe for mobile accordion

5. **Accessibility Features**
   - aria-expanded on mobile category toggle
   - aria-label for navigation elements
   - role="menu" and role="menuitem" for semantic structure
   - Keyboard-friendly buttons
   - Focus management with body scroll lock

#### Architecture Maintained:
- Server-Side Rendering (SSR) for category data
- Client-Side Interactivity (CSR) for UI state
- Clean component separation (Navbar → NavbarClient)
- API Layer abstraction (categoriesApi.js)
- SCSS Modules with design tokens
- RTL layout support
- Performance optimized (useCallback, ISR caching)

#### Technical Implementation:
- Server Component: Fetches categories via `getCategoryTree()`
- Client Component: Handles state (menu open/close, accordion expansion)
- Prop drilling: categories passed from server to client
- URL structure: `/products?category={slug}&subcategory={subslug}`

---

## [Latest] - 2025-11-03

### Refactor: Navbar MegaMenu Hover Stability & Animation
**Status**: ✅ COMPLETED (100%)

#### Changes Made:
1. Always-render mega menu with state-driven visibility class (`.megaMenuVisible`) to prevent flicker and gaps.
2. Unified SCSS: removed duplicate `.megaMenu` blocks and hover-coupled open rules; single transition source of truth.
3. Smooth open/close with opacity+translate transitions; pointer-events managed for stability.
4. Hover intent: delayed close (300ms) with enter/leave handlers to avoid accidental dismiss.
5. Accessibility: added `aria-label` and `aria-hidden`, and focus enter/leave to support keyboard.

#### Files Updated:
- `src/modules/layout/Navbar/NavbarClient.jsx`
- `src/modules/layout/Navbar/Navbar.module.scss`

#### Architecture & Styling:
- Preserved SSR snapshot from `Navbar.jsx` and API layer.
- SCSS Modules with design tokens; RTL friendly.

### Migration: Product Detail Page Route Refactor
**Status**: ✅ COMPLETED (100%)

#### Changes Made:
1. **Route Migration**
   - Moved: `src/app/products/[slug]/page.js` → `src/app/product/[slug]/page.js`
   - Moved: `src/app/products/[slug]/page.module.scss` → `src/app/product/[slug]/page.module.scss`
   - Rationale: Distinguish singular product detail page from plural products listing page

2. **Component Updates**
   - `src/components/cards/ProductCard/ProductCard.jsx`: Updated link from `/products/${slug}` to `/product/${slug}`
   - ProductGrid.jsx uses ProductCard component, so links are automatically updated

3. **Verification**
   - ✅ SSR rendering preserved (metadata generation intact)
   - ✅ Dynamic route params properly handled with `await params`
   - ✅ API Layer abstraction maintained (getProductBySlug from productsApi.js)
   - ✅ Error handling preserved (notFound() for invalid slugs)
   - ✅ Styles and layout unchanged

#### Architecture Maintained:
- Clean Architecture with API Layer abstraction
- Repository Pattern (productsApi.js)
- Server-Side Rendering (SSR) for SEO
- SCSS Module structure
- RTL layout support

#### Old Route:
- `src/app/products/[slug]/page.js` still exists (can be cleaned up or repurposed for categories)

#### New Route:
- `src/app/product/[slug]/page.js` now active for singular product detail pages
## [Latest] - 2025-11-04

### Enhancement: Dropdown Arrow on "محصولات" with Open State
**Status**: ✅ COMPLETED (100%)

#### Changes Made:
1. Added a toggleable arrow icon next to the "محصولات" link that rotates upward when the MegaMenu is open.
2. Updated `src/modules/layout/Navbar/NavbarClient.jsx` to render the arrow SVG and bind its open state to `isMegaMenuOpen`.
3. Updated `src/modules/layout/Navbar/Navbar.module.scss` with `.navLinkContent`, `.dropdownIcon`, and `.dropdownIconOpen` classes using design tokens (no hard-coded values).

#### Impact:
- Clear affordance for dropdown behavior on desktop navigation, aligned with RTL and theme tokens.

---

## [Latest] - 2025-11-06

### Enhancement: productsApi.getProductsPaginated category/subcategory filters
**Status**: ✅ COMPLETED (100%)

#### Changes Made:
1. Extended `src/lib/productsApi.js` → `getProductsPaginated(page, pageSize, sort, options?)` to accept optional `{ categorySlug, subCategorySlug, subSlugs = [] }` without breaking existing callers.
2. Implemented Strapi v4 filters via `URLSearchParams`:
   - If `subCategorySlug` → `filters[subCategory][slug][$eq] = {subCategorySlug}`
   - Else if `categorySlug` → OR filter:
     - `filters[$or][0][category][slug][$eq] = {categorySlug}`
     - `filters[$or][1][subCategory][slug][$in] = subSlugs.join(',')` (when provided)
3. Preserved output structure: `{ data, meta }` unchanged, including pagination meta and error fallback.

#### Notes:
- `subSlugs` should be provided by SSR from `categoriesApi` when a category is selected to include all its subcategories.
- No UI/component changes required; API remains backward-compatible with previous 3-arg calls.

### Feature: SSR Initial Render from URL for /products
**Status**: ✅ COMPLETED (100%)

#### Changes Made:
1. Updated `src/app/products/page.js` to read `searchParams` → `category`, `sub`, `sort`, `page`.
2. When `category` present and `sub` absent, fetched `getCategoryTree()` and derived `subSlugs` for that category.
3. Called `getProductsPaginated(page, 6, sort, { categorySlug, subCategorySlug, subSlugs })` for initial SSR data.
4. Fetched categories snapshot via `getCategoryTree()` and passed to client.
5. Added `src/modules/products/ProductsPageClient/ProductsPageClient.jsx` (client) to receive initial props and render `ProductGrid`.

#### Impact:
- Enables direct URL-driven SSR filtering and pagination for better SEO and first paint.
- Keeps Clean Architecture with API Layer and server→client data flow.

### Feature: CategoryFilter component (UI-only, emits events)
**Status**: ✅ COMPLETED (100%)

#### Changes Made:
1. Added `src/modules/products/components/CategoryFilter.jsx` (client component) with two states:
   - No active category: shows scrollable category pills.
   - Active category: large selected box on the right + subcategory pills on the left.
2. Added `src/modules/products/components/CategoryFilter.module.scss` styled with theme tokens:
   - Dark background, gold accents, RTL-friendly layout.
   - Hover/active states, subtle elevation, responsive grid (2→1 columns on mobile).
3. Accessibility: `aria-label`, `aria-pressed`, `type="button"` on interactive elements.

#### Usage Notes:
- Receives data via props; emits only events: `onSelectCategory(slug)`, `onSelectSubCategory(slug)`.
- Update URL handling in the parent to set `?category=` and `?sub=` as needed.

### Enhancement: ProductGrid filtering + pagination reset logic
**Status**: ✅ COMPLETED (100%)

#### Changes Made:
1. `src/modules/products/ProductGrid/ProductGrid.jsx`
   - Added `category` and `sub` query params to all fetches.
   - On `sort`, `activeCategory`, or `activeSubCategory` change: refetch from page 1 and replace products.
   - On load more: fetch next page in current filters and append.
   - Standardized `PAGE_SIZE` to 6 and aligned `page`/`hasMore` with API meta.

### Enhancement: /api/products route supports filters (category, sub, sort, page, pageSize)
**Status**: ✅ COMPLETED (100%)

#### Changes Made:
1. Updated `src/app/api/products/route.js` to parse `category`, `sub`, `sort`, `page`, `pageSize`.
2. When a category is selected without a subcategory, derive `subSlugs` via `getCategoryTree()` for inclusive filtering.
3. Call `getProductsPaginated(page, pageSize, sort, { categorySlug, subCategorySlug, subSlugs })` and return `{ data, meta }` unchanged.

#### Impact:
- Ensures URL-driven UX for `/products`, `/products/{category}`, and `/products/{category}/{sub}` with correct filtering and pagination.

### Fix: Align product filters with `categories` relation slug equality
**Status**: ✅ COMPLETED (100%)

#### Changes Made:
1. Updated `src/lib/productsApi.js` → `getProductsPaginated` query build to:
   - If `subCategorySlug`: `filters[categories][slug][$eq] = subCategorySlug`
   - Else if `categorySlug`: `filters[categories][slug][$eq] = categorySlug`

#### Rationale:
- Backend expects filtering via unified `categories` relation; removes previous OR/in logic.

